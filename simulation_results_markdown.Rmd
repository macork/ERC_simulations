---
title: "Simulation_results"
author: "Michael Cork"
date: "2022-08-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(data.table)
library(tidyverse)
```

# Load all of the data used in these results
```{r}
exp_relationship = "linear"
adjust_confounder = T
time_stamp = "linear_all"
replicates = 100

# Grab repo directory whether on the cluster or computer
if (Sys.getenv("USER") == "mcork") {
  repo_dir <- "/n/dominici_nsaph_l3/projects/ERC_simulation/Simulation_studies/"
} else if (Sys.getenv("USER") == "michaelcork") {
  repo_dir <- "~/Desktop/Francesca_research/Simulation_studies/"
}

results_dir <- paste0(repo_dir, "results/",
                      exp_relationship, "_", adjust_confounder, "/", time_stamp, "/")

aggregated_results <- readRDS(file = paste0(results_dir, "aggregated_results.RDS"))

correlation_linear <- aggregated_results$correlation
metrics_linear <- aggregated_results$metrics
predictions_linear <- aggregated_results$predictions

# load sublinear
exp_relationship = "sublinear"
adjust_confounder = T
time_stamp = "sublinear_all2"
replicates = 500

results_dir <- paste0(repo_dir, "results/",
                      exp_relationship, "_", adjust_confounder, "/", time_stamp, "/")

aggregated_results <- readRDS(file = paste0(results_dir, "aggregated_results.RDS"))

correlation_sublinear <- aggregated_results$correlation
metrics_sublinear <- aggregated_results$metrics
predictions_sublinear <- aggregated_results$predictions

# load threshold
exp_relationship = "threshold"
adjust_confounder = T
time_stamp = "threshold_all"
replicates = 100

results_dir <- paste0(repo_dir, "results/",
                      exp_relationship, "_", adjust_confounder, "/", time_stamp, "/")

aggregated_results <- readRDS(file = paste0(results_dir, "aggregated_results.RDS"))

correlation_threshold <- aggregated_results$correlation
metrics_threshold <- aggregated_results$metrics
predictions_threshold <- aggregated_results$predictions

```

## Results 

Our baseline evaluation is using the simple covariate setting, with an interaction term 

$$
\begin{split} 
Y|E,C &\sim N(\mu(E, C), 10^2) \\
\mu(E, C) &= 20 + E - (2, 2, 3, -1, 2, 2)*C + E(-0.1C_1 + 0.1C_3^2 + 0.1C_4 + 0.1C_5)
\end{split}
$$


### How do different exposure-outcome relationships show up in our simulations
For the basis of my results I am going to use a an interaction term for the outcome relationship, a simple covariate structure, and a sample size of 1000.

#### Linear exposure response curve
```{r}
plot_data_linear <- 
  metrics_linear %>% 
  mutate(absolute_bias = abs(bias)) %>% 
  tidyr::pivot_longer(c("bias", "absolute_bias", "mse")) %>% 
  mutate(model = factor(model, levels = c("linear_model", "linear_gps", "gam_model", "gam_gps", "causal_gps_default", "causal_gps_tuned", "change_model", "propensity_change")))  %>% 
  dplyr::group_by(model, gps_mod, sample_size, confounder_setting, out_relationship, name) %>% 
  dplyr::summarize(mean = mean(value), 
                   lower = quantile(value, 0.05),
                   upper = quantile(value, 0.95)) %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  mutate(out_relationship = factor(out_relationship, levels = c("linear", "interaction")))

# Plot results from linear

plot_bias_linear <- 
  plot_data_linear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(sample_size == 1000, confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias facet by outcome relationship"))
plot_bias_linear


plot_data_linear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(confounder_setting == "nonzero", out_relationship == "interaction") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ sample_size) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias as a function of sample size"))

# Ok something weird is happening with a nonzero relationship in the confounder 
plot_data_linear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(sample_size == 10000, out_relationship == "interaction") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5, 3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ confounder_setting) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias facet by confounder distribution"))

# note that making linear does not do anything. So making the coefficients non zero helps make it unbiased, which is weird. What might be going on here? Want to ask Kevin potentially


plot_abs_bias_linear <- 
  plot_data_linear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "absolute_bias") %>% 
  filter(sample_size == 1000, confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  scale_y_continuous(trans='log10') + 
  theme_bw() + 
  #coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
    labs(y = "Bias", x = "Confounding Scenario", title = paste("Absolute bias with linear exposure-outcome relationship"))

plot_abs_bias_linear

plot_data_linear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "absolute_bias") %>% 
  filter(out_relationship == "interaction", confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  scale_y_continuous(trans='log10') + 
  theme_bw() + 
  #coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
    labs(y = "Bias", x = "Confounding Scenario", title = paste("Absolute bias with linear exposure-outcome relationship"))


# Now look at trace plots for linear case, might give better idea of what is going on here 

pred_plot <-
  predictions_linear %>%
  filter(confounder_setting == "simple", out_relationship == "interaction", sample_size == 1000) %>% 
  dplyr::select(-causal_gps_default) %>% 
  tidyr::pivot_longer(c("linear_model", "linear_gps", "gam_model", "gam_gps", "change_model", "causal_gps_tuned", "true_fit")) %>%
  mutate(name = factor(name, levels = c("linear_model", "linear_gps", "gam_model", "gam_gps", "causal_gps_tuned", "change_model", "propensity_change", "true_fit"))) %>% 
  data.table()

pred_summary <-
  pred_plot[,.(mean = mean(value),
               lower = quantile(value, 0.05),
               upper = quantile(value, 0.95)), by=.(exposure, gps_mod, sample_size, confounder_setting, out_relationship, name)] %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  data.table()

# Get a sample of predictions to plot
pred_sample <- 
  pred_plot[sim %in% sample(1:20, 10, replace = F)] %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  data.table()

true_fit_plot <- pred_summary[name == "true_fit"] %>% dplyr::select(-name) %>% data.table()


gg_trace_plot_interaction <- 
  ggplot() +
  geom_line(data = pred_summary[name != "true_fit" & sample_size == 1000], aes(x = exposure, y = mean), linetype = "solid") +
  geom_line(data = true_fit_plot[sample_size == 1000], aes(x = exposure, y = mean), color = "black", linetype = "dashed") +
  geom_line(data = pred_sample[name != "true_fit" & sample_size == 1000], aes(x = exposure, y = value, color = factor(sim)), linetype = "solid", alpha = 0.5) + 
  scale_color_manual(values = c("gray", "gray","gray", "gray", "gray", "gray", "gray", "gray", "gray", "gray")) + 
  labs(x = "Exposure", y = "Response") +
  theme_bw() +
  coord_cartesian(ylim = c(-20, 20)) + 
  facet_grid(name ~ gps_mod) + 
  theme(legend.position = "none") + 
  theme(text = element_text(size = 16))  

gg_trace_plot_interaction

```

#### Sublinear

```{r}
plot_data_sublinear <- 
  metrics_sublinear %>% 
  mutate(absolute_bias = abs(bias)) %>% 
  tidyr::pivot_longer(c("bias", "absolute_bias", "mse")) %>% 
  mutate(model = factor(model, levels = c("linear_model", "linear_gps", "gam_model", "gam_gps", "causal_gps_default", "causal_gps_tuned", "change_model", "propensity_change")))  %>% 
  dplyr::group_by(model, gps_mod, sample_size, confounder_setting, out_relationship, name) %>% 
  dplyr::summarize(mean = mean(value), 
                   lower = quantile(value, 0.05),
                   upper = quantile(value, 0.95)) %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction")))

# Plot results from linear

plot_bias_sublinear <- 
  plot_data_sublinear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(sample_size == 10000, confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  #coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias with linear exposure-outcome relationship"))
plot_bias_sublinear


plot_data_sublinear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(confounder_setting == "simple", out_relationship == "interaction") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  coord_cartesian(ylim = c(-20, 20)) + 
  facet_wrap(~ sample_size) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias with linear exposure-outcome relationship"))

# Ok something weird is happening with a nonzero relationship in the confounder 
plot_data_sublinear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(sample_size == 10000, out_relationship == "interaction") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5, 3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ confounder_setting) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias with linear exposure-outcome relationship"))


plot_abs_bias_sublinear <- 
  plot_data_sublinear %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "absolute_bias") %>% 
  filter(sample_size == 10000, confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  scale_y_continuous(trans='log10') + 
  theme_bw() + 
  #coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
    labs(y = "Bias", x = "Confounding Scenario", title = paste("Absolute bias with linear exposure-outcome relationship"))

plot_abs_bias_sublinear

# Now make prediction plots (or trace plots)
pred_plot <-
  predictions_sublinear %>%
  filter(confounder_setting == "simple", out_relationship == "interaction", sample_size == 1000) %>% 
  dplyr::select(-causal_gps_default) %>% 
  tidyr::pivot_longer(c("linear_model", "linear_gps", "gam_model", "gam_gps", "change_model", "causal_gps_tuned", "true_fit")) %>%
  mutate(name = factor(name, levels = c("linear_model", "linear_gps", "gam_model", "gam_gps", "causal_gps_tuned", "change_model", "propensity_change", "true_fit"))) %>% 
  data.table()

pred_summary <-
  pred_plot[,.(mean = mean(value),
               lower = quantile(value, 0.05),
               upper = quantile(value, 0.95)), by=.(exposure, gps_mod, sample_size, confounder_setting, out_relationship, name)] %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  data.table()

# Get a sample of predictions to plot
pred_sample <- 
  pred_plot[sim %in% sample(1:20, 10, replace = F)] %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  data.table()

true_fit_plot <- pred_summary[name == "true_fit"] %>% dplyr::select(-name) %>% data.table()


gg_trace_plot_interaction <- 
  ggplot() +
  geom_line(data = pred_summary[name != "true_fit" & sample_size == 1000], aes(x = exposure, y = mean), linetype = "solid") +
  geom_line(data = true_fit_plot[sample_size == 1000], aes(x = exposure, y = mean), color = "black", linetype = "dashed") +
  geom_line(data = pred_sample[name != "true_fit" & sample_size == 1000], aes(x = exposure, y = value, color = factor(sim)), linetype = "solid", alpha = 0.5) + 
  scale_color_manual(values = c("gray", "gray","gray", "gray", "gray", "gray", "gray", "gray", "gray", "gray")) + 
  labs(x = "Exposure", y = "Response") +
  theme_bw() +
  coord_cartesian(ylim = c(-5, 10)) + 
  facet_grid(name ~ gps_mod) + 
  theme(legend.position = "none") + 
  theme(text = element_text(size = 16))  

gg_trace_plot_interaction

```


### Testing results
This can be ignored for now

```{r, eval = F}
sample_size = 10000
cf <- mvrnorm(n = sample_size,
                      mu = rep(0, 4),
                      Sigma = diag(4))
        cf5 <- sample(c((-2):2), sample_size, replace = T)
        cf6 <- runif(sample_size, min = -3, max = 3)
confounders = cbind(cf, cf5, cf6)
colnames(confounders) = c("cf1", "cf2", "cf3", "cf4", "cf5", "cf6")
cf <- confounders
x = 9 * cov_function(confounders) + 18 + rnorm(sample_size, mean = 0, sd = sqrt(10))
exp_frame = data.frame(confounders, exposure = 9 * cov_function(confounders) + 18 + rnorm(sample_size, mean = 0, sd = sqrt(10))) %>% filter(exposure > 0)

exposure = exp_frame$exposure
cf = as.matrix(exp_frame[, c("cf1", "cf2", "cf3", "cf4", "cf5", "cf6")])
transformed_exp = 3 * log(exposure + 1)
Y = transformed_exp
Y = Y + as.numeric(20 - c(2, 2, 3, -1, -2, -2) %*% t(cf) - 
                             transformed_exp*(-0.1 * cf[, 1] + 0.1 * cf[, 3]^2 + 0.1*cf[, 4] + 0.1*cf[, 5]) + rnorm(length(exposure), mean = 0, sd = 10))
data_example 
exposure_relationship = "sublinear"
gam_fit <- mgcv::gam(Y ~ s(exposure) + cf1 + cf2 + cf3 + cf4 + cf5 + cf6, data = data_example, family = family)

data_prediction <- 
    rbindlist(lapply(seq(0, 20, length.out = discrete_points), function(pot_exp) {
      potential_data <- cbind(data.frame(cf), exposure = pot_exp)
      
      # Add on exposure effect depending on relationship
      if (exposure_relationship == "linear") {
        potential_data$transformed_exp <- potential_data$exposure
        Y = potential_data$transformed_exp
      } else if (exposure_relationship == "sublinear") {
        potential_data$transformed_exp = 3 * log(potential_data$exposure + 1)
        Y = potential_data$transformed_exp
      } else if (exposure_relationship == "threshold") {
        # Set threshold at 5
        thresh_exp <- potential_data$exposure 
        thresh_exp[thresh_exp <= 5] <- 0
        thresh_exp[thresh_exp > 5] <- thresh_exp[thresh_exp > 5] - 5
        potential_data$transformed_exp <- 1.5 * thresh_exp
        Y = Y + thresh_exp
      }
      
      # Add on effect of the confounders
      if (outcome_relationship == "linear") {
        Y = Y + as.numeric(20 - c(2, 2, 3, -1, -2, -2) %*% t(dplyr::select(potential_data, cf1, cf2, cf3, cf4, cf5, cf6)))
      } else if (outcome_relationship == "interaction") {
        # problem with the threshold exposure scenario happening 
        Y = Y + as.numeric(20 - c(2, 2, 3, -1, -2, -2) %*% t(dplyr::select(potential_data, cf1, cf2, cf3, cf4, cf5, cf6)) - 
                             potential_data$transformed_exp*(-0.1 * potential_data$cf1 + 0.1 * potential_data$cf3^2 + 0.1*potential_data$cf4 + 0.1*potential_data$cf5))
      } else {
        stop("Outcome relationship for now is only between linear and interaction")
      }
      
      # # Add on exposure effect
      # if (exposure_relationship == "linear") {
      #   Y = Y + potential_data$exposure
      # } else if (exposure_relationship == "sublinear") {
      #   Y = Y + 8 * log10(potential_data$exposure + 1)
      # } else if (exposure_relationship == "threshold") {
      #   # Set threshold at 5
      #   thresh_exp <- potential_data$exposure 
      #   thresh_exp[thresh_exp <= 5] <- 0
      #   thresh_exp[thresh_exp > 5] <- thresh_exp[thresh_exp > 5] - 5
      #   Y = Y + thresh_exp
      # }
      
      # Fit each model and take mean for ERC
      potential_outcome <- 
        potential_data %>% 
        mutate(gam_model = predict(gam_fit, newdata = potential_data, type = "response"),
               true_fit = Y) %>% 
        dplyr::select(exposure, gam_model, true_fit) %>% 
        summarize_all(mean) %>% 
        data.table()
      return(potential_outcome)
    }))

plot_fits <- 
    data_prediction %>% 
    pivot_longer(c("gam_model", "true_fit"), names_to = "model", values_to = "prediction") %>%
    arrange(exposure) %>%
    ggplot(aes(x = exposure, y = prediction, color = model, linetype = model)) +
    geom_line() +
    labs(x = "Exposure concentration", y = "Relative risk of death")




df <- 
  data.frame(exposure = seq(0, 20, length.out = 100)) %>% 
  mutate(outcome = 3 * log(exposure + 1))

gam_fit <- gam::gam(outcome ~ s(exposure, df = 4), data = df, family = "gaussian")
plot(mgcv::gam(outcome ~ s(exposure), data = df))


```
#### Threshold


```{r}
plot_data_threshold <- 
  metrics_threshold %>% 
  mutate(absolute_bias = abs(bias)) %>% 
  tidyr::pivot_longer(c("bias", "absolute_bias", "mse")) %>% 
  mutate(model = factor(model, levels = c("linear_model", "linear_gps", "gam_model", "gam_gps", "causal_gps_default", "causal_gps_tuned", "change_model", "propensity_change")))  %>% 
  dplyr::group_by(model, gps_mod, sample_size, confounder_setting, out_relationship, name) %>% 
  dplyr::summarize(mean = mean(value), 
                   lower = quantile(value, 0.05),
                   upper = quantile(value, 0.95)) %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction")))

# Plot results from linear

plot_bias_threshold <- 
  plot_data_threshold %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "bias") %>% 
  filter(sample_size == 10000, confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  #scale_y_continuous(trans='log10') + 
  theme_bw() + 
  #coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
  labs(y = "Bias", x = "Confounding Scenario", title = paste("Bias with linear exposure-outcome relationship"))


plot_abs_bias_threshold <- 
  plot_data_threshold %>% 
  filter(model != "causal_gps_default") %>% 
  filter(name == "absolute_bias") %>% 
  filter(sample_size == 10000, confounder_setting == "simple") %>% 
  ggplot() + 
  geom_pointrange(aes(y = mean, ymin = lower, ymax = upper, x = factor(gps_mod), color = model), position = position_dodge(.6)) +
  geom_vline(xintercept=c(1.5, 2.5,3.5, 4.5, 5.5), linetype="dashed", size = 0.2) + 
  labs(x = "Scenario", y = "Value") + 
  scale_y_continuous(trans='log10') + 
  theme_bw() + 
  #coord_cartesian(ylim = c(-15, 15)) + 
  facet_wrap(~ out_relationship) + 
    labs(y = "Bias", x = "Confounding Scenario", title = paste("Absolute bias with linear exposure-outcome relationship"))

plot_bias_threshold
plot_abs_bias_threshold

# Now make prediction plots (or trace plots)
pred_plot <-
  predictions_threshold %>%
  filter(confounder_setting == "simple", out_relationship == "interaction", sample_size == 1000) %>% 
  dplyr::select(-causal_gps_default) %>% 
  tidyr::pivot_longer(c("linear_model", "linear_gps", "gam_model", "gam_gps", "change_model", "causal_gps_tuned", "true_fit")) %>%
  mutate(name = factor(name, levels = c("linear_model", "linear_gps", "gam_model", "gam_gps", "causal_gps_tuned", "change_model", "propensity_change", "true_fit"))) %>% 
  data.table()

pred_summary <-
  pred_plot[,.(mean = mean(value),
               lower = quantile(value, 0.05),
               upper = quantile(value, 0.95)), by=.(exposure, gps_mod, sample_size, confounder_setting, out_relationship, name)] %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  data.table()

# Get a sample of predictions to plot
pred_sample <- 
  pred_plot[sim %in% sample(1:20, 10, replace = F)] %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  data.table()

true_fit_plot <- pred_summary[name == "true_fit"] %>% dplyr::select(-name) %>% data.table()


gg_trace_plot_interaction <- 
  ggplot() +
  geom_line(data = pred_summary[name != "true_fit" & sample_size == 1000], aes(x = exposure, y = mean), linetype = "solid") +
  geom_line(data = true_fit_plot[sample_size == 1000], aes(x = exposure, y = mean), color = "black", linetype = "dashed") +
  geom_line(data = pred_sample[name != "true_fit" & sample_size == 1000], aes(x = exposure, y = value, color = factor(sim)), linetype = "solid", alpha = 0.5) + 
  scale_color_manual(values = c("gray", "gray","gray", "gray", "gray", "gray", "gray", "gray", "gray", "gray")) + 
  labs(x = "Exposure", y = "Response") +
  theme_bw() +
  coord_cartesian(ylim = c(-20, 20)) + 
  facet_grid(name ~ gps_mod) + 
  theme(legend.position = "none") + 
  theme(text = element_text(size = 16))  

gg_trace_plot_interaction

```



### How does sample size affect our estimates? 

In general, increased sample size leads to improved covariate balance when fitting causal inference methods. It also leads to improvements in fit for methods that use nonparametric 



### How do different covariate distributions affect estimation of ERC?

We are comparing how either a simple covariate distribution or a more complex covariate distribution affects covariate balance first. In the simple case all covariates are uncorrelated and centered at zero. In more complex setting they are not cenetered at zero and $C_1, C_2, C_3, C_4$ are correlated. 

We first investigate how it affects covariate balance. In general, we notice that more complex confounder distributions result in larger covariate imbalances in the nonlinear and interaction settings in our simulation, and therefore reduce the covariate balance for all methods. In particular, this is the case when fitting under the matching framework, which is not very surprising given unlike the IPW weighting it is not targetting covariate balance. (note which type of covariate balance we are using in this problem). 

Now we can assess how these different covariate distributions affect the bias of our estimates

## How do different covariate-oucome relationships affect estimation fo the ERC

Between a linear or interaction effect we don't have a different in covariate balance, given that the covariate balance is didcated between the covariates and the outcome 

```{r}
exp_relationship = "linear"
adjust_confounder = T
time_stamp = "linear_all"
replicates = 100

# Grab repo directory whether on the cluster or computer
if (Sys.getenv("USER") == "mcork") {
  repo_dir <- "/n/dominici_nsaph_l3/projects/ERC_simulation/Simulation_studies/"
} else if (Sys.getenv("USER") == "michaelcork") {
  repo_dir <- "~/Desktop/Francesca_research/Simulation_studies/"
}

results_dir <- paste0(repo_dir, "results/",
                      exp_relationship, "_", adjust_confounder, "/", time_stamp, "/")

aggregated_results <- readRDS(file = paste0(results_dir, "aggregated_results.RDS"))

correlation <- aggregated_results$correlation
metrics <- aggregated_results$metrics
predictions <- aggregated_results$predictions


# First look at covariate balance
mean_abs_cor <- 
  correlation %>% 
  group_by(method, delta, gps_mod, sample_size, sim, confounder_setting, out_relationship) %>% 
  dplyr::summarize(pre_cor = mean(pre_cor), post_cor = mean(post_cor)) %>% 
  mutate(covariate = "mean") %>% 
  ungroup()

# Add mean to correlation table
correlation <- 
  rbind(correlation, mean_abs_cor) %>% 
  mutate(covariate = factor(covariate, levels = rev(c("cf1", "cf2", "cf3", "cf4", "cf5", "cf6", "mean"))))



gg_correlation_ipw <-
  correlation %>% 
  filter(sample_size == 1000, out_relationship == "linear") %>% 
  filter(method == "ipw", confounder_setting %in% c("simple", "complex")) %>% 
  pivot_longer(c("pre_cor", "post_cor"), names_to = "correlation") %>% 
  group_by(gps_mod, covariate, correlation, out_relationship, confounder_setting) %>% 
  dplyr::summarize(mean = mean(value),
                   lower = quantile(value, 0.05), 
                   upper = quantile(value, 0.95)) %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  ggplot(aes(x = covariate, y = mean, ymin = lower, ymax = upper, color = correlation, group = correlation)) +
  geom_hline(aes(yintercept = 0.1)) + 
  geom_errorbar(width = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7)) + 
  #geom_line(size = 0.3) +
  theme_bw() +
  coord_flip() + 
  facet_grid(confounder_setting ~ gps_mod) + 
  labs(y = "Absolute correlation", x = "Covariate", title = "Covariate balance using IPW and entropy based weights")

gg_correlation_tuned <-
  correlation %>% 
  filter(sample_size == 1000, out_relationship == "linear") %>% 
  filter(method == "causal_gps_tuned", confounder_setting %in% c("simple", "complex")) %>% 
  mutate(confounder_setting = factor(confounder_setting, levels = c("simple", "complex"))) %>% 
  pivot_longer(c("pre_cor", "post_cor"), names_to = "correlation") %>% 
  group_by(gps_mod, covariate, correlation, out_relationship, confounder_setting) %>% 
  dplyr::summarize(mean = mean(value),
                   lower = quantile(value, 0.05), 
                   upper = quantile(value, 0.95)) %>% 
  mutate(gps_mod = factor(case_when(gps_mod == 1 ~ "linear", 
                                    gps_mod == 2 ~ "heavy tail", 
                                    gps_mod == 3 ~ "nonlinear", 
                                    gps_mod == 4 ~ "interaction"), levels = c("linear", "heavy tail", "nonlinear", "interaction"))) %>% 
  ggplot(aes(x = covariate, y = mean, ymin = lower, ymax = upper, color = correlation, group = correlation)) +
  geom_hline(aes(yintercept = 0.1)) + 
  geom_errorbar(width = 0.5, position = position_dodge(width = 0.7)) +
  geom_point(position = position_dodge(width = 0.7)) + 
  #geom_line(size = 0.3) +
  theme_bw() +
  coord_flip() + 
  facet_grid(confounder_setting ~ gps_mod) + 
  labs(y = "Absolute correlation", x = "Covariate", title = "Covariate balance using IPW and entropy based weights")


gg_correlation_tuned





```


How do different covariate effects on the outcome impact estimation of the ERC (covariate-outcome effect)? How does 

How do different relationships between the exposure and outcome affect estimation of the ERC (exposure effect)?
How do different propensity score models impact estimation of the ERC?
How do different covariate effects on the outcome impact estimation of the ERC (covariate-outcome effect)?
How do different covariate distributions affect estimation of ERC?
How does sample size impact estimation of the ERC?


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
